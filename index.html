<html>
<a id="codepen-link" href="https://www.codepen.io/seanfree" target="_blank"></a>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.1/dat.gui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
  <style>
    #container canvas {
      background: #0c0c0c;
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }

    #codepen-link {
      position: absolute;
      bottom: 30px;
      right: 30px;
      height: 40px;
      width: 40px;
      z-index: 10;
      border-radius: 50%;
      box-sizing: border-box;
      background-image: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/544318/logo.jpg');
      background-position: center center;
      background-size: cover;
      opacity: 0.4;
      transition: all 0.25s;
    }

    #codepen-link:hover {
      opacity: 0.8;
      box-shadow: 0 0 6px #efefef;
    }
  </style>
</head>
<body>

  <div id="container">
    <a id="codepen-link" href="https://www.codepen.io/seanfree" target="_blank"></a>

<script>
/* jshint esversion: 6 */
((main) => {

  this.requestAnimationFrame = (() => {
    return window.requestAnimationFrame ||
      window.webkitRequestAnimationFrame ||
      window.mozRequestAnimationFrame ||
      window.oRequestAnimationFrame ||
      window.msRequestAnimationFrame ||
      function(callback) {
        window.setTimeout(callback, 1000 / 60);
      };
  })();

  main(this, document, THREE);

})((window, document, three, undefined) => {

  'use strict';

  const APP_DEFAULTS = {
    dimensions: {
      x: 0,
      y: 0
    },
    camera: {
      fov: 70,
      aspectRatio: 0,
      nearPlane: 0.1,
      farPlane: 10000,
      distanceX: 50,
      distanceY: 700,
      distanceZ: -50,
      speedX: 0.8,
      speedY: 0.4,
      speedZ: 0.1
    },
    particles: {
      ySegments: 100,
      xSegments: 300,
      size: 1,
      color: '#67e2f2',
      waveSpeed: 0.5,
      waveSizeX: 250,
      waveSizeY: 0,
      waveSizeZ: 250
    }
  };

  const PI = Math.PI,
    TAU = PI * 2,
    COS = Math.cos,
    SIN = Math.sin;

  class App {
    constructor() {
      let self = this;
      self.props = (JSON.parse(JSON.stringify(APP_DEFAULTS)));
      self.initCamera();
      self.initScene();
      self.initLights();
      self.stats = new Stats();
      document.body.appendChild(this.stats.domElement);
      window.onresize = () => {
        self.setSize();
      };
    }

    setSize() {
      this.props.dimensions.x = window.innerWidth;
      this.props.dimensions.y = window.innerHeight;
      this.renderer.setSize(this.props.dimensions.x, this.props.dimensions.y);
      this.camera.aspect = this.props.camera.aspectRatio = this.props.dimensions.x / this.props.dimensions.y;
      this.camera.updateProjectionMatrix();
    }

    initCamera() {
      this.camera = new three.PerspectiveCamera(
        this.props.camera.fov,
        this.props.camera.aspectRatio,
        this.props.camera.nearPlane,
        this.props.camera.farPlane
      );
    }

    initScene() {
      this.scene = new three.Scene();
      this.scene.add(this.camera);
      this.renderer = new THREE.WebGLRenderer({
        alpha: true,
        antialias: true
      });
      this.setSize();
      this.container = document.querySelector('#container');
      this.container.appendChild(this.renderer.domElement);
    }

    initLights() {
      this.mainLight = new three.HemisphereLight(0x000000, 0xffffff, 0.95);
      this.mainLight.position.set(0, -500, 0);
      this.scene.add(this.mainLight);

      this.ambientLight = new three.AmbientLight(0xaaccff, 0.95);
      this.ambientLight.position.set(-200, -100, 0);
      this.scene.add(this.ambientLight);
    }

    render() {
      let self = this;
      self.stats.begin();
      self.update();
      self.renderer.render(self.scene, self.camera);
      window.requestAnimationFrame(self.render.bind(self));
      self.stats.end();
    }

    update() {}
  }

  class MandalaCloud extends App {
    constructor() {
      super();
      this.tick = 0;
      this.build();
      this.initGUI();
      this.render();
    }

    build() {
      let self = this, 
        mat = new three.PointsMaterial({
          color: new three.Color(this.props.particles.color),
          transparent: true,
          depthTest: true,
          size: 1
        });

      this.geometry = new three.SphereGeometry(400, this.props.particles.ySegments, this.props.particles.xSegments, 0, TAU, 0, TAU);

      this.pointCloud = new three.Points(this.geometry, mat);
      this.pointCloud.sortParticles = true;

      this.scene.add(this.pointCloud);
      this.camera.position.set(0, -600, 600);
    }

    update() {
      this.tick++;
      this.delta = this.tick * 0.005;
      this.geometry.verticesNeedUpdate = true;
      for (let i = 0; i < this.geometry.vertices.length; i++) {
        let point = this.geometry.vertices[i],
          dX = SIN(this.delta + i) * (this.props.particles.waveSizeX * 0.004),
          dY = COS(this.delta + i) * SIN(this.delta + i) * (this.props.particles.waveSizeY * 0.004),
          dZ = COS(this.delta + i) * (this.props.particles.waveSizeZ * 0.004);
        point.add(new three.Vector3(dX, dY, dZ));
      }
      this.camera.lookAt(this.pointCloud.position);
      this.camera.position.x = this.props.camera.distanceX * COS(this.delta * this.props.camera.speedX);
      this.camera.position.y = this.props.camera.distanceY * COS(this.delta * this.props.camera.speedY);
      this.camera.position.z = this.props.camera.distanceZ * COS(this.delta * this.props.camera.speedZ);
    }

    reset() {
      this.tick = 0;
      this.scene.remove(this.pointCloud);
      this.build();
    }

    initGUI() {

      this.gui = new dat.GUI();
      let f1 = this.gui.addFolder('إعدادات المظهر');

      f1.add(this.props.camera, 'البعد العمودي').step(5).min(-700).max(700);
      f1.add(this.props.camera, 'البعد الافقي').step(5).min(-700).max(700);
      f1.add(this.props.camera, 'البعد الكلي').step(5).min(-700).max(700);

      f1.add(this.props.camera, 'سرعة الموجة الأفقية').step(0.1).min(0).max(1);
      f1.add(this.props.camera, 'سرعة الموجة العمودية').step(0.1).min(0).max(1);
      f1.add(this.props.camera, 'السرعة الكلية').step(0.1).min(0).max(1);
      f1.open();

      let f2 = this.gui.addFolder('إعدادات الجسيمات');

      f2.add(this.props.particles, 'قوة الموجة الأفقية').step(10).min(10).max(400).onFinishChange(() => {
        this.reset();
      });
      f2.add(this.props.particles, 'قوة الموجة العمودية').step(10).min(10).max(400).onFinishChange(() => {
        this.reset();
      });
      f2.add(this.props.particles, 'حجم النقاط').step(1).min(1).max(10).onChange((value) => {
        this.pointCloud.material.size = value;
      });
      f2.addColor(this.props.particles, 'color').onChange((value) => {
        this.pointCloud.material.color = new three.Color(value);
      });
      f2.add(this.props.particles, 'الموجة االأفقية').step(5).min(0).max(400).onFinishChange(() => {
        this.reset();
      });
      f2.add(this.props.particles, 'الموجة العمودية').step(5).min(0).max(400).onFinishChange(() => {
        this.reset();
      });
      f2.add(this.props.particles, 'إتجاه الموجة').step(5).min(0).max(400).onFinishChange(() => {
        this.reset();
      });

      f2.open();
    }
  }

  window.onload = () => {
    let mc = new MandalaCloud();
  };

});
</script>
</body>
</html>
